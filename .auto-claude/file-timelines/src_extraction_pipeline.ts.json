{
  "file_path": "src/extraction/pipeline.ts",
  "main_branch_history": [],
  "task_views": {
    "004-add-cross-stage-confidence-warnings-to-ui": {
      "task_id": "004-add-cross-stage-confidence-warnings-to-ui",
      "branch_point": {
        "commit_hash": "faf3f69f9b2794c6a85ffd2581461d3d68bdf8ef",
        "content": "",
        "timestamp": "2025-12-22T03:09:58.791154"
      },
      "worktree_state": {
        "content": "/**\n * Extraction pipeline functions for board image processing and confidence analysis.\n */\n\nimport {\n  ExtractionStage,\n  StageConfidence,\n  ConfidenceHint,\n  HintSeverity,\n} from './types';\n\n/** Threshold below which a stage confidence is considered low */\nconst LOW_CONFIDENCE_THRESHOLD = 0.7;\n\n/** Threshold above which variance across stages triggers a warning */\nconst HIGH_VARIANCE_THRESHOLD = 0.15;\n\n/** Human-readable names for each extraction stage */\nconst STAGE_DISPLAY_NAMES: Record<ExtractionStage, string> = {\n  BOARD_DETECTION: 'Board detection',\n  GRID_ALIGNMENT: 'Grid dimensions',\n  CELL_EXTRACTION: 'Cell extraction',\n  PIP_RECOGNITION: 'Pip recognition',\n};\n\n/** Suggestions for improving confidence at each stage */\nconst STAGE_SUGGESTIONS: Record<ExtractionStage, string> = {\n  BOARD_DETECTION: 'Ensure the entire board is visible and centered in the frame',\n  GRID_ALIGNMENT: 'Try capturing from directly above the board with less angle',\n  CELL_EXTRACTION: 'Ensure good lighting and avoid shadows across the board',\n  PIP_RECOGNITION: 'Make sure pip markings are clearly visible and not worn',\n};\n\n/**\n * Calculate the variance of confidence values.\n */\nfunction calculateVariance(confidences: number[]): number {\n  if (confidences.length === 0) return 0;\n  const mean = confidences.reduce((sum, c) => sum + c, 0) / confidences.length;\n  const squaredDiffs = confidences.map((c) => (c - mean) ** 2);\n  return squaredDiffs.reduce((sum, d) => sum + d, 0) / confidences.length;\n}\n\n/**\n * Determine severity based on confidence value.\n */\nfunction getSeverityForConfidence(confidence: number): HintSeverity {\n  if (confidence < 0.5) return 'high';\n  if (confidence < 0.7) return 'medium';\n  return 'low';\n}\n\n/**\n * Analyze stage confidences and generate human-readable warning hints.\n *\n * Generates hints for:\n * - Individual stages with low confidence (< 0.7)\n * - High variance across stages (variance > 0.15)\n *\n * @param stageConfidences Array of confidence scores for each pipeline stage\n * @returns Array of human-readable hints about confidence issues\n */\nexport function generateConfidenceHints(\n  stageConfidences: StageConfidence[],\n): ConfidenceHint[] {\n  const hints: ConfidenceHint[] = [];\n\n  if (stageConfidences.length === 0) {\n    return hints;\n  }\n\n  // Check for low confidence in individual stages\n  for (const sc of stageConfidences) {\n    if (sc.confidence < LOW_CONFIDENCE_THRESHOLD) {\n      const stageName = STAGE_DISPLAY_NAMES[sc.stage];\n      hints.push({\n        stage: sc.stage,\n        severity: getSeverityForConfidence(sc.confidence),\n        message: `Low confidence in ${stageName}`,\n        suggestion: STAGE_SUGGESTIONS[sc.stage],\n      });\n    }\n  }\n\n  // Check for high variance across stages\n  const confidenceValues = stageConfidences.map((sc) => sc.confidence);\n  const variance = calculateVariance(confidenceValues);\n\n  if (variance > HIGH_VARIANCE_THRESHOLD) {\n    // Find the stage with lowest confidence to attach this hint to\n    const lowestStage = stageConfidences.reduce((min, sc) =>\n      sc.confidence < min.confidence ? sc : min,\n    );\n\n    hints.push({\n      stage: lowestStage.stage,\n      severity: 'medium',\n      message: 'Extraction confidence varies significantly across stages',\n      suggestion: 'Some stages performed much better than others. Review the extraction results carefully.',\n    });\n  }\n\n  return hints;\n}\n\n/**\n * Calculate the overall confidence from stage confidences.\n * Uses weighted average, giving more weight to later stages as they depend on earlier ones.\n *\n * @param stageConfidences Array of confidence scores for each pipeline stage\n * @returns Overall confidence score from 0 to 1\n */\nexport function calculateOverallConfidence(\n  stageConfidences: StageConfidence[],\n): number {\n  if (stageConfidences.length === 0) return 0;\n\n  // Simple average for now; could be weighted by stage importance\n  const sum = stageConfidences.reduce((acc, sc) => acc + sc.confidence, 0);\n  return sum / stageConfidences.length;\n}\n",
        "last_modified": "2025-12-22T03:10:02.238043"
      },
      "task_intent": {
        "title": "004-add-cross-stage-confidence-warnings-to-ui",
        "description": "Display the confidence hints generated by generateConfidenceHints() in the mobile app's extraction results screen. The backend already computes these hints but the UI only shows the overall confidence percentage.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2025-12-22T03:10:00.359544",
  "last_updated": "2025-12-22T03:10:00.456129"
}