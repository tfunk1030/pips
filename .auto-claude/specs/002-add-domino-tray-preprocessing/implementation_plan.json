{
  "feature": "Add Domino Tray Preprocessing",
  "description": "Apply image preprocessing pipeline (CLAHE, brightness normalization, white balance) to cropped domino tray images before AI extraction to improve domino pip detection accuracy, especially in low-light photos.",
  "created_at": "2025-12-22T07:00:27.566Z",
  "updated_at": "2025-12-22T07:10:00.000Z",
  "status": "planning",
  "planStatus": "complete",
  "workflow_type": "development",
  "services_involved": [
    "extract_dominoes.py",
    "preprocess.py"
  ],
  "spec_file": "spec.md",
  "phases": [
    {
      "id": "phase-1",
      "name": "Core Preprocessing Module",
      "description": "Create the image preprocessing functions for domino tray images",
      "subtasks": [
        {
          "id": "1.1",
          "title": "Create preprocessing module with CLAHE function",
          "description": "Create preprocess.py with apply_clahe() function that applies Contrast Limited Adaptive Histogram Equalization to improve local contrast in domino images",
          "status": "completed",
          "acceptance_criteria": [
            "Function accepts BGR image (numpy array)",
            "Converts to LAB color space for CLAHE application on L channel",
            "Uses cv2.createCLAHE with configurable clipLimit and tileGridSize",
            "Returns enhanced BGR image",
            "Default parameters: clipLimit=2.0, tileGridSize=(8,8)"
          ],
          "files": [
            "preprocess.py"
          ],
          "notes": "Created preprocess.py with apply_clahe() function. Implements CLAHE on LAB L-channel with configurable clipLimit and tileGridSize. All acceptance criteria met and verified with tests.",
          "updated_at": "2025-12-22T07:08:38.244323+00:00"
        },
        {
          "id": "1.2",
          "title": "Add brightness normalization function",
          "description": "Add normalize_brightness() function to preprocess.py that adjusts image brightness to a target mean",
          "status": "completed",
          "acceptance_criteria": [
            "Function accepts BGR image and optional target brightness (default 128)",
            "Calculates current mean brightness from V channel of HSV",
            "Scales V channel to achieve target brightness while preventing clipping",
            "Returns brightness-normalized BGR image"
          ],
          "files": [
            "preprocess.py"
          ],
          "notes": "Added normalize_brightness() function to preprocess.py. Function uses HSV color space V channel for brightness calculation, scales to target brightness with clipping prevention, and handles edge cases (black images, invalid parameters). All acceptance criteria met and verified with tests.",
          "updated_at": "2025-12-22T07:10:43.260882+00:00"
        },
        {
          "id": "1.3",
          "title": "Add white balance function",
          "description": "Add apply_white_balance() function to preprocess.py using gray-world assumption",
          "status": "pending",
          "acceptance_criteria": [
            "Function accepts BGR image",
            "Implements gray-world white balance (scale each channel to match average)",
            "Optional: provide 'gray_world' and 'white_patch' methods",
            "Returns color-corrected BGR image"
          ],
          "files": [
            "preprocess.py"
          ]
        },
        {
          "id": "1.4",
          "title": "Create combined preprocessing pipeline function",
          "description": "Add preprocess_domino_tray() function that chains all preprocessing steps in optimal order",
          "status": "pending",
          "acceptance_criteria": [
            "Function chains: white_balance -> brightness_normalize -> CLAHE",
            "Accepts optional flags to enable/disable each step",
            "Logs or returns metrics about adjustments made",
            "Default enables all preprocessing steps"
          ],
          "files": [
            "preprocess.py"
          ]
        }
      ]
    },
    {
      "id": "phase-2",
      "name": "Integration with Domino Extraction",
      "description": "Integrate preprocessing into the domino extraction pipeline",
      "subtasks": [
        {
          "id": "2.1",
          "title": "Refactor extract_dominoes.py to use preprocessing",
          "description": "Update extract_dominoes.py to apply preprocessing before pip detection",
          "status": "pending",
          "acceptance_criteria": [
            "Import preprocess_domino_tray from preprocess module",
            "Apply preprocessing to full image before domino detection",
            "Add --no-preprocess flag for A/B comparison",
            "Preserve original functionality when preprocessing disabled"
          ],
          "files": [
            "extract_dominoes.py",
            "preprocess.py"
          ]
        },
        {
          "id": "2.2",
          "title": "Add preprocessing to individual domino tile extraction",
          "description": "Apply preprocessing to each cropped domino tile for enhanced pip counting",
          "status": "pending",
          "acceptance_criteria": [
            "Option to preprocess individual cropped tiles (not just full image)",
            "May use different CLAHE parameters for small crops",
            "Configurable via flag: --tile-preprocess"
          ],
          "files": [
            "extract_dominoes.py"
          ]
        }
      ]
    },
    {
      "id": "phase-3",
      "name": "Debug and Visualization Tools",
      "description": "Add debugging capabilities to visualize preprocessing effects",
      "subtasks": [
        {
          "id": "3.1",
          "title": "Add debug output for preprocessing stages",
          "description": "Save intermediate images showing each preprocessing step",
          "status": "pending",
          "acceptance_criteria": [
            "Add --debug flag to extract_dominoes.py",
            "When enabled, save: original, after_white_balance, after_brightness, after_clahe images",
            "Save to debug_preprocess/ directory",
            "Include histogram comparison images"
          ],
          "files": [
            "extract_dominoes.py",
            "preprocess.py"
          ]
        },
        {
          "id": "3.2",
          "title": "Create comparison visualization script",
          "description": "Script to show side-by-side comparison of with/without preprocessing",
          "status": "pending",
          "acceptance_criteria": [
            "Create compare_preprocessing.py script",
            "Shows original vs preprocessed image side by side",
            "Shows pip detection results with/without preprocessing",
            "Outputs comparison image to debug directory"
          ],
          "files": [
            "compare_preprocessing.py"
          ]
        }
      ]
    },
    {
      "id": "phase-4",
      "name": "Testing and Validation",
      "description": "Test preprocessing with sample images and validate improvements",
      "subtasks": [
        {
          "id": "4.1",
          "title": "Create unit tests for preprocessing functions",
          "description": "Add pytest tests for each preprocessing function",
          "status": "pending",
          "acceptance_criteria": [
            "Create tests/test_preprocess.py",
            "Test apply_clahe with synthetic images",
            "Test normalize_brightness achieves target brightness",
            "Test white_balance corrects color cast",
            "Test pipeline function chains correctly"
          ],
          "files": [
            "tests/test_preprocess.py"
          ]
        },
        {
          "id": "4.2",
          "title": "Validate with existing domino images",
          "description": "Test preprocessing on IMG_2050.png and IMG_2051.png",
          "status": "pending",
          "acceptance_criteria": [
            "Run extract_dominoes.py with preprocessing on both images",
            "Document pip detection accuracy with/without preprocessing",
            "Save comparison images to debug directory",
            "Verify no regression in well-lit images"
          ],
          "files": []
        }
      ]
    }
  ],
  "dependencies": {
    "1.2": [
      "1.1"
    ],
    "1.3": [
      "1.1"
    ],
    "1.4": [
      "1.1",
      "1.2",
      "1.3"
    ],
    "2.1": [
      "1.4"
    ],
    "2.2": [
      "2.1"
    ],
    "3.1": [
      "2.1"
    ],
    "3.2": [
      "3.1"
    ],
    "4.1": [
      "1.4"
    ],
    "4.2": [
      "2.1",
      "3.1"
    ]
  },
  "estimated_effort": "small",
  "tech_stack": [
    "Python",
    "OpenCV",
    "NumPy"
  ],
  "final_acceptance": [
    "Preprocessing module (preprocess.py) with CLAHE, brightness, and white balance functions",
    "extract_dominoes.py updated to use preprocessing pipeline",
    "Debug visualization tools for preprocessing comparison",
    "Unit tests for all preprocessing functions",
    "Validation on existing domino images shows improved pip detection"
  ],
  "qa_signoff": {
    "status": "pending",
    "tests_passed": null,
    "issues": null
  },
  "last_updated": "2025-12-22T07:10:43.260882+00:00"
}