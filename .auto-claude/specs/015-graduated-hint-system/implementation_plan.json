{
  "feature": "Graduated 4-Level Hint System",
  "workflow_type": "feature",
  "workflow_rationale": "This is net-new functionality that adds a graduated hint revelation system to the puzzle application. It's not refactoring existing code, fixing bugs, or migrating infrastructureâ€”it's building a new user-facing capability that requires both frontend UI components and backend logic for hint generation.",

  "phases": [
    {
      "id": "phase-1-backend-api",
      "name": "Backend API Setup",
      "type": "implementation",
      "description": "Add FastAPI HTTP server to pips-agent to expose hint generation endpoint",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Add FastAPI dependencies to pips-agent",
          "service": "pips-agent",
          "files_to_modify": ["requirements.txt"],
          "files_to_create": [],
          "patterns_from": ["cv-service/main.py"],
          "verification": {
            "type": "command",
            "command": "cd pips-agent && python -c \"import fastapi, uvicorn; print('OK')\"",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-1-2",
          "description": "Create FastAPI server wrapper in pips-agent",
          "service": "pips-agent",
          "files_to_modify": [],
          "files_to_create": ["api_server.py"],
          "patterns_from": ["cv-service/main.py"],
          "verification": {
            "type": "command",
            "command": "cd pips-agent && python -c \"from api_server import app; print('OK')\"",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-1-3",
          "description": "Create /generate-hint POST endpoint with request/response models",
          "service": "pips-agent",
          "files_to_modify": ["api_server.py"],
          "files_to_create": [],
          "patterns_from": ["cv-service/main.py"],
          "verification": {
            "type": "api",
            "method": "POST",
            "url": "http://localhost:8001/generate-hint",
            "body": {
              "puzzle_spec": {"pips": {"pip_min": 0, "pip_max": 6}, "dominoes": {"tiles": [[1,2]]}, "board": {"shape": ["##"], "regions": ["AB"]}, "region_constraints": {"A": {"type": "sum", "op": "==", "value": 3}}},
              "level": 1
            },
            "expected_status": 200
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-2-hint-logic",
      "name": "Backend Hint Generation Logic",
      "type": "implementation",
      "description": "Extend hint_engine.py to generate 4 distinct hint levels",
      "depends_on": ["phase-1-backend-api"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Implement Level 1 hint generation (strategic guidance)",
          "service": "pips-agent",
          "files_to_modify": ["utils/hint_engine.py"],
          "files_to_create": [],
          "patterns_from": ["utils/hint_engine.py"],
          "verification": {
            "type": "command",
            "command": "cd pips-agent && python -c \"from utils.hint_engine import generate_hint_level_1; print('OK')\"",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-2",
          "description": "Implement Level 2 hint generation (focused direction to region)",
          "service": "pips-agent",
          "files_to_modify": ["utils/hint_engine.py"],
          "files_to_create": [],
          "patterns_from": ["utils/hint_engine.py"],
          "verification": {
            "type": "command",
            "command": "cd pips-agent && python -c \"from utils.hint_engine import generate_hint_level_2; print('OK')\"",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-3",
          "description": "Implement Level 3 hint generation (specific cell placement)",
          "service": "pips-agent",
          "files_to_modify": ["utils/hint_engine.py"],
          "files_to_create": [],
          "patterns_from": ["tools/solve_puzzle.py"],
          "verification": {
            "type": "command",
            "command": "cd pips-agent && python -c \"from utils.hint_engine import generate_hint_level_3; print('OK')\"",
            "expected": "OK"
          },
          "status": "pending",
          "notes": "Requires solve_puzzle logic to derive one correct cell placement"
        },
        {
          "id": "subtask-2-4",
          "description": "Implement Level 4 hint generation (partial solution 3-5 cells)",
          "service": "pips-agent",
          "files_to_modify": ["utils/hint_engine.py"],
          "files_to_create": [],
          "patterns_from": ["tools/solve_puzzle.py"],
          "verification": {
            "type": "command",
            "command": "cd pips-agent && python -c \"from utils.hint_engine import generate_hint_level_4; print('OK')\"",
            "expected": "OK"
          },
          "status": "pending",
          "notes": "Requires solve_puzzle logic to derive multiple correct cell placements"
        },
        {
          "id": "subtask-2-5",
          "description": "Wire hint level functions to /generate-hint endpoint",
          "service": "pips-agent",
          "files_to_modify": ["api_server.py"],
          "files_to_create": [],
          "patterns_from": ["utils/hint_engine.py"],
          "verification": {
            "type": "api",
            "method": "POST",
            "url": "http://localhost:8001/generate-hint",
            "body": {
              "puzzle_spec": {"pips": {"pip_min": 0, "pip_max": 6}, "dominoes": {"tiles": [[1,2]]}, "board": {"shape": ["##"], "regions": ["AB"]}, "region_constraints": {"A": {"type": "sum", "op": "==", "value": 3}}},
              "level": 1
            },
            "expected_status": 200
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-3-frontend-ui",
      "name": "Frontend Hint Modal UI",
      "type": "implementation",
      "description": "Create HintModal component with 4-level progression controls",
      "depends_on": ["phase-1-backend-api"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Create HintModal component with level buttons",
          "service": "pips-solver",
          "files_to_modify": [],
          "files_to_create": ["src/app/components/HintModal.tsx"],
          "patterns_from": ["src/app/components/AIVerificationModal.tsx", "src/app/components/ui/Button.tsx"],
          "verification": {
            "type": "command",
            "command": "cd pips-solver && npx tsc --noEmit src/app/components/HintModal.tsx",
            "expected": "No errors"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-2",
          "description": "Add API client function to call /generate-hint endpoint",
          "service": "pips-solver",
          "files_to_modify": [],
          "files_to_create": ["src/services/hintService.ts"],
          "patterns_from": ["src/services"],
          "verification": {
            "type": "command",
            "command": "cd pips-solver && npx tsc --noEmit src/services/hintService.ts",
            "expected": "No errors"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-3",
          "description": "Integrate HintModal into PuzzleViewerScreen with hint button",
          "service": "pips-solver",
          "files_to_modify": ["src/app/screens/PuzzleViewerScreen.tsx"],
          "files_to_create": [],
          "patterns_from": ["src/app/components/HintModal.tsx"],
          "verification": {
            "type": "command",
            "command": "cd pips-solver && npx tsc --noEmit src/app/screens/PuzzleViewerScreen.tsx",
            "expected": "No errors"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-4",
          "description": "Add AsyncStorage persistence for last hint level",
          "service": "pips-solver",
          "files_to_modify": ["src/app/components/HintModal.tsx"],
          "files_to_create": [],
          "patterns_from": ["src/storage"],
          "verification": {
            "type": "command",
            "command": "cd pips-solver && npx tsc --noEmit src/app/components/HintModal.tsx",
            "expected": "No errors"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-4-integration",
      "name": "Integration & Testing",
      "type": "integration",
      "description": "Wire frontend to backend and verify end-to-end hint flow",
      "depends_on": ["phase-2-hint-logic", "phase-3-frontend-ui"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "End-to-end verification of all 4 hint levels",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Start pips-agent API server (uvicorn api_server:app --port 8001)",
              "Start pips-solver frontend (npm start)",
              "Open PuzzleViewerScreen",
              "Tap 'Hint' button",
              "Request Level 1 - verify strategic guidance text",
              "Request Level 2 - verify region identification",
              "Request Level 3 - verify specific cell placement",
              "Request Level 4 - verify partial solution (3-5 cells)",
              "Verify no console errors"
            ]
          },
          "status": "pending"
        },
        {
          "id": "subtask-4-2",
          "description": "Edge case testing (solved puzzle, invalid state, network error)",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Test: 1) Request hint on solved puzzle - verify 'already solved' message. 2) Request hint on invalid state - verify error guidance. 3) Simulate network error - verify retry mechanism."
          },
          "status": "pending"
        }
      ]
    }
  ],

  "summary": {
    "total_phases": 4,
    "total_subtasks": 13,
    "services_involved": ["pips-agent", "pips-solver"],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": ["phase-1-backend-api", "phase-3-frontend-ui"],
          "reason": "Phase 1 (backend API setup) and Phase 3 (frontend UI) can run in parallel since they work on different services and don't share files. Phase 3 only needs Phase 1's API structure (not full hint logic) which is established early."
        }
      ],
      "recommended_workers": 1,
      "speedup_estimate": "1.2x faster if parallel execution used, but sequential recommended for simpler coordination"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 015 --parallel 1"
  },

  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": ["unit", "integration"],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All 4 hint levels generate contextually relevant hints",
      "Frontend can request and display hints for all levels",
      "Hint progression is user-controlled (no auto-escalation)",
      "Edge cases handled (solved puzzle, invalid state, network errors)",
      "No regressions in existing puzzle functionality"
    ],
    "verification_steps": [
      {
        "name": "Backend Unit Tests",
        "command": "cd pips-agent && pytest tests/test_hint_engine.py -v",
        "expected_outcome": "All hint level generation tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Backend API Integration Tests",
        "command": "cd pips-agent && pytest tests/test_api_server.py -v",
        "expected_outcome": "API endpoint tests pass for all levels",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Frontend Component Tests",
        "command": "cd pips-solver && npm test -- HintModal",
        "expected_outcome": "HintModal component tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "End-to-End Manual Verification",
        "command": "Manual testing in Expo app",
        "expected_outcome": "All 4 hint levels work in UI, edge cases handled",
        "type": "manual",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Medium risk feature with algorithmic complexity requires unit tests for each hint level and integration tests for API. Manual E2E verification needed to confirm hint quality and UX."
  },

  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": ["cd pips-agent && pytest tests/test_hint_engine.py", "cd pips-solver && npm test"],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": ["cd pips-agent && pytest tests/test_api_server.py"],
      "services_to_test": ["pips-agent", "pips-solver"]
    },
    "e2e_tests": {
      "required": true,
      "commands": [],
      "flows": ["hint-level-1-request", "hint-level-2-request", "hint-level-3-request", "hint-level-4-request", "hint-progression-flow"]
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:3000/puzzle",
          "checks": ["Hint button visible", "HintModal opens", "All 4 level buttons functional", "Hints display correctly", "No console errors"]
        }
      ]
    },
    "database_verification": {
      "required": false,
      "checks": []
    }
  },

  "qa_signoff": null
}
