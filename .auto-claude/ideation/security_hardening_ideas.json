{
  "security_hardening": [
    {
      "id": "sec-001",
      "type": "security_hardening",
      "title": "Remediate exposed Anthropic API key in pips-agent/.env",
      "description": "A real Anthropic API key (sk-ant-api03-vb9Pi...) is exposed in pips-agent/.env file. While pips-agent/.gitignore excludes .env files, the root .gitignore only excludes .auto-claude/.env. If this file was committed before the subdirectory gitignore was added, the key persists in git history.",
      "rationale": "Exposed API keys allow attackers to make unauthorized API calls at the victim's expense. Anthropic API keys provide unrestricted access to Claude models. Once keys are in git history, they persist even after deletion from current files. This is an immediate, exploitable vulnerability.",
      "category": "secrets_management",
      "severity": "critical",
      "affectedFiles": [
        "pips-agent/.env",
        ".gitignore"
      ],
      "vulnerability": "CWE-798: Use of Hard-coded Credentials",
      "currentRisk": "Real Anthropic API token (sk-ant-api03-...) is visible in pips-agent/.env. Attackers with repository access can immediately use this key for unauthorized Claude API access, potentially incurring significant costs.",
      "remediation": "1) IMMEDIATELY rotate the Anthropic API key at console.anthropic.com. 2) Add '**/.env' and '.env' patterns to root .gitignore. 3) Verify git history for commits containing .env: `git log --all --full-history -- '**/.env'`. 4) Use BFG Repo-Cleaner or git-filter-repo to purge secrets from history if found. 5) Implement pre-commit hooks using gitleaks to prevent future commits. 6) Use environment injection at runtime for production deployments.",
      "references": [
        "https://owasp.org/www-community/vulnerabilities/Use_of_hard-coded_credentials",
        "https://cwe.mitre.org/data/definitions/798.html",
        "https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/removing-sensitive-data-from-a-repository"
      ],
      "compliance": ["SOC2", "PCI-DSS", "GDPR"]
    },
    {
      "id": "sec-002",
      "type": "security_hardening",
      "title": "Use expo-secure-store for API keys in React Native app",
      "description": "The pips-solver React Native app stores API keys in AsyncStorage (puzzles.ts lines 42-47). The AppSettings interface includes openrouterApiKey, anthropicApiKey, googleApiKey, and openaiApiKey fields, all stored in unencrypted local storage accessible to any app with storage permissions.",
      "rationale": "Mobile devices are frequently lost, stolen, or compromised. AsyncStorage data is stored in plain SQLite on Android and plist on iOS, readable by any app with storage access. Users entering their personal API keys trust the app to protect these credentials.",
      "category": "data_protection",
      "severity": "high",
      "affectedFiles": [
        "pips-solver/src/storage/puzzles.ts"
      ],
      "vulnerability": "CWE-312: Cleartext Storage of Sensitive Information",
      "currentRisk": "API keys entered by users are stored in plaintext AsyncStorage. A malicious app, rooted device, or backup extraction can access these keys, enabling unauthorized API usage billed to the user.",
      "remediation": "1) Install expo-secure-store: `npx expo install expo-secure-store`. 2) Create secureStorage.ts module using SecureStore for sensitive data. 3) Move API key fields to SecureStore while keeping preferences in AsyncStorage. 4) Implement migration for existing users: read from AsyncStorage, write to SecureStore, delete from AsyncStorage. 5) SecureStore uses iOS Keychain and Android Keystore for encrypted storage.",
      "references": [
        "https://docs.expo.dev/versions/latest/sdk/securestore/",
        "https://owasp.org/www-project-mobile-top-10/2016-risks/m2-insecure-data-storage",
        "https://cwe.mitre.org/data/definitions/312.html"
      ],
      "compliance": ["SOC2", "PCI-DSS", "GDPR"]
    },
    {
      "id": "sec-003",
      "type": "security_hardening",
      "title": "Restrict CORS origins and add security headers to CV service",
      "description": "The cv-service FastAPI application (main.py:26-32) uses allow_origins=['*'] with allow_credentials=True - a particularly dangerous CORS configuration. No security headers (CSP, X-Frame-Options, HSTS) are configured. This allows any website to make authenticated cross-origin requests.",
      "rationale": "The combination of wildcard origins with credentials is explicitly warned against in CORS specifications. While the service is currently stateless, this pattern creates security debt and enables CSRF-like attacks if authentication is added. Any malicious website can interact with the API.",
      "category": "configuration",
      "severity": "high",
      "affectedFiles": [
        "cv-service/main.py"
      ],
      "vulnerability": "CWE-942: Overly Permissive Cross-domain Whitelist",
      "currentRisk": "Any website can make cross-origin requests to the CV service. An attacker could trick users into visiting a malicious page that sends images to your service, potentially for reconnaissance or abuse.",
      "remediation": "1) Use environment-based CORS: ALLOWED_ORIGINS env var. 2) Development: ['http://localhost:3000', 'http://localhost:19006', 'exp://*']. 3) Only enable allow_credentials when origins are explicitly listed. 4) Add security headers middleware for X-Content-Type-Options, X-Frame-Options, Referrer-Policy. 5) Consider adding HTTPS enforcement header (Strict-Transport-Security) for production.",
      "references": [
        "https://owasp.org/www-community/attacks/cors-chained-with-xss",
        "https://fastapi.tiangolo.com/tutorial/cors/",
        "https://cwe.mitre.org/data/definitions/942.html",
        "https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#credentialed_requests_and_wildcards"
      ],
      "compliance": ["SOC2", "OWASP Top 10"]
    },
    {
      "id": "sec-004",
      "type": "security_hardening",
      "title": "Add rate limiting and request size validation to CV service",
      "description": "The cv-service endpoints (/extract-geometry, /crop-puzzle, /crop-dominoes, /preprocess-image) accept base64-encoded images without rate limiting or pre-decode size validation. The decode_image function (line 70-83) processes any size payload. Image processing with OpenCV is CPU-intensive, making DoS attacks effective.",
      "rationale": "Without rate limiting, a single client can exhaust server resources. The base64 decode and image processing operations are expensive. An attacker sending rapid requests or massive payloads can deny service to legitimate users or cause out-of-memory crashes.",
      "category": "configuration",
      "severity": "medium",
      "affectedFiles": [
        "cv-service/main.py"
      ],
      "vulnerability": "CWE-770: Allocation of Resources Without Limits or Throttling",
      "currentRisk": "Attackers can submit unlimited requests or oversized images to crash the service, consume memory, or exhaust CPU, affecting availability for legitimate users.",
      "remediation": "1) Install slowapi: `pip install slowapi`. 2) Add rate limiting decorator: @limiter.limit('10/minute') per IP. 3) Validate base64 string length before decode: max 15MB (len(base64_str) * 0.75 < 11MB). 4) Add uvicorn limit: --limit-request-body-size 15000000. 5) Validate decoded image dimensions: max 4096x4096 pixels. 6) Add request timeouts using asyncio.wait_for for CV operations.",
      "references": [
        "https://owasp.org/www-community/controls/Blocking_Brute_Force_Attacks",
        "https://slowapi.readthedocs.io/en/latest/",
        "https://cwe.mitre.org/data/definitions/770.html"
      ],
      "compliance": ["SOC2"]
    },
    {
      "id": "sec-005",
      "type": "security_hardening",
      "title": "Run Docker container as non-root user and pin dependencies",
      "description": "The cv-service Dockerfile runs as root (no USER directive). Additionally, requirements.txt files use >= version specifiers without lock files, allowing dependency versions to drift between builds. No yarn.lock or package-lock.json found for complete dependency resolution.",
      "rationale": "Running as root amplifies any container vulnerability impact. Dependency drift can introduce untested code or known CVEs. OpenCV image parsing vulnerabilities combined with root privileges could enable container escape. Defense-in-depth requires minimal privileges.",
      "category": "configuration",
      "severity": "medium",
      "affectedFiles": [
        "cv-service/Dockerfile",
        "cv-service/requirements.txt",
        "pips-agent/requirements.txt"
      ],
      "vulnerability": "CWE-250: Execution with Unnecessary Privileges",
      "currentRisk": "Container runs as root. OpenCV, numpy, or Pillow vulnerabilities could be exploited to gain root access. Combined with kernel vulnerabilities, this enables container escape to host system.",
      "remediation": "1) Add non-root user to Dockerfile: RUN adduser --disabled-password appuser && chown -R appuser /app && USER appuser. 2) Generate lock files: pip-compile requirements.txt -o requirements.lock. 3) Add security scanning: pip-audit in CI pipeline. 4) Consider distroless base images for minimal attack surface. 5) Add securityContext in K8s: runAsNonRoot: true, readOnlyRootFilesystem: true.",
      "references": [
        "https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html",
        "https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#user",
        "https://cwe.mitre.org/data/definitions/250.html",
        "https://pypi.org/project/pip-audit/"
      ],
      "compliance": ["SOC2", "CIS Docker Benchmark"]
    }
  ],
  "metadata": {
    "dependenciesScanned": 24,
    "knownVulnerabilities": 0,
    "filesAnalyzed": 52,
    "criticalIssues": 1,
    "highIssues": 2,
    "mediumIssues": 2,
    "lowIssues": 0,
    "generatedAt": "2025-12-22T03:20:00Z",
    "analysisScope": [
      "cv-service (FastAPI Python backend)",
      "pips-agent (Python Claude Agent SDK)",
      "pips-solver (React Native/Expo frontend)"
    ],
    "owasp_categories_covered": [
      "A01:2021 Broken Access Control (CORS misconfiguration)",
      "A02:2021 Cryptographic Failures (Cleartext storage of API keys)",
      "A05:2021 Security Misconfiguration (Docker root, CORS, missing rate limits)",
      "A06:2021 Vulnerable Components (Unpinned dependencies)",
      "A07:2021 Authentication Failures (API key management)"
    ],
    "keyFindings": {
      "mostCritical": "Exposed Anthropic API key in pips-agent/.env requires immediate rotation",
      "highestRisk": "CORS allow_origins=['*'] with allow_credentials=True violates CORS security model",
      "quickWins": [
        "Add '**/.env' to root .gitignore",
        "Rotate exposed API key immediately",
        "Add USER directive to Dockerfile"
      ]
    }
  }
}
